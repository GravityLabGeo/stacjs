<!doctype html>
<html lang="en">
<head>
	<meta http-equiv="X-UA-Compatible" content="IE=edge" />
	<meta http-equiv="content-type" content="text/html; charset=UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<title>STAC Browser Test</title>

    <script type='text/javascript' src="stac.js"></script>
    <script type='text/javascript' src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

    <style>

        body {
            margin: 0;
            background-color: #EAECEE;
        }

        th {text-align: left}

        .infopanel {
            box-shadow: inset 0 1px 2px rgba(0,0,0,.39), 0 -1px 1px #FFF, 0 1px 0 #FFF;
            width: 100%;
            height: 11em;
            background-color: #EAECEE;
            padding: 0.3em
        }

        .infopanel2 {
            box-shadow: inset 0 1px 2px rgba(0,0,0,.39), 0 -1px 1px #FFF, 0 1px 0 #FFF;
            width: 100%;
            background-color: #EAECEE;
            padding: 0.3em
        }

        .infopanel-scroll{
            height: 5em;
            overflow: scroll;
        }

       .column {
            float: left;
        }

        .left {
            width: 65%;
        }

        .right {
            width: 35%;
        }

        /* Clear floats after the columns */
        .row: after {
            content: "";
            display: table;
            clear: both;
        }


    </style>
</head>
<body>

    <div class="row">
        <div class="infopanel" id="navigation_panel">
            <label>URL to root:
            <input id="rooturl" type="text"
                    size="90"/>
                </label>
            <button onclick="loadIndex()">Load</button>

            <div id="parent_link" style="margin: 2em; float: right"></div>
            <div>
                <p>Sample catalogs:<br/>
                <span>https://storage.googleapis.com/pdd-stac/disasters/catalog.json</span>
                </p>
            </div>

            <div class="infopanel-scroll">
                <div class="infopanel"  id="root_panel"></div>
            </div>

        </div>
    </div>

    <div class="row">
        <div class="column left">
            <div class="infopanel2" id="current_panel">
                <div>
                    <div id="current_info"></div>
                </div>
                <div style="display: none">
                    <pre id="json_code"></pre>
                </div>
                <div>
                    <h3>Links</h3>
                    <div id="current_links"></div>
                </div>
            </div>
        </div>

        <div class="column right">

            <div class="infopanel2" id="preview_panel">
                <pre id="json_preview"></pre>
            </div>
        </div>
    </div>


<script>

    var idx = null;
    var parentNode = null;
    var currentNode = null;

//https://storage.googleapis.com/pdd-stac/disasters/catalog.json
//https://s3-us-west-2.amazonaws.com/radiant-nasa-iserv/iserv.json

    var defaultroot = "https://storage.googleapis.com/pdd-stac/disasters/catalog.json";
    $('#rooturl').val(defaultroot);

    function clearMessages(){
        $('#messages').empty();
    }

    function appendMessage(msg){
        $('#messages').append(msg).append('<br />');
    }

    function dumpObject(obj){
        $('#dump').empty();
        var json = JSON.stringify(obj, undefined, 2);
        $('#dump').append(json);
    }

    function loadIndex(){
        var rooturl = $('#rooturl').val();
        idx = new Index();
        idx.initialize(rooturl);
        populateRootCatalogHtml(idx.getRootNode());
        populateCurrentInfoHtml(idx.getRootNode())
        populateLinkHtml(idx.getRootNode());
        currentNode = idx.getRootNode();
        parentNode = null;
        setParentLink(null);
    }

    function goTo(rel, href){
        var link = currentNode.getEntry().findLink(href);
        var node = currentNode.fetchChildNode(link);
        if ('item' == rel){
            displayPreview(node);
        } else {
            clearPreview();
            populateCurrentInfoHtml(node);
            populateLinkHtml(node);
            parentNode = currentNode;
            currentNode = node;
            setParentLink(parentNode);
        }
        return false;
    }

    function displayPreview(node){
        var pretty = JSON.stringify(node.getEntry(), undefined, 2);
        $('#json_preview').empty();
        $('#json_preview').append(pretty);
    }

    function clearPreview(){
        $('#json_preview').empty();
    }

    function goToParent(href){
        //we already have the parent so just walk back
        clearPreview();
        populateCurrentInfoHtml(parentNode);
        populateLinkHtml(parentNode);
        currentNode = parentNode;
        parentNode = currentNode.parentNode; //set from the parentNode property of this node
        setParentLink(parentNode);
        return false;
    }

    function populateRootCatalogHtml(node){
        var entry = node.getEntry();
        $('#root_panel').empty();
        $('#root_panel').append('<div>').append('<strong>License:</strong> ' +entry.license.name );
        $('#root_panel').append('<div>').append('<strong>Contact:</strong> ' +entry.contact.name );
        $('#root_panel').append('<div>').append('<a href="' + entry.homepage + '" target=_blank >homepage</a>');
    }

    function setParentLink(node){
        $('#parent_link').empty();
        if (null == node) {
            $('#parent_link').append("[Root Catalog]");
        } else {
            var vr = "'" + node.url + "'";
            $('#parent_link').append(  '<a onclick="event.preventDefault(); goToParent('+ vr +')" href="">[parent] </a>');
        }
    }

    function populateCurrentInfoHtml(node){
        var entry = node.getEntry();
        $('#current_info').empty();
        $('#current_info').append('<div>').append('<strong>Name:</strong> ' + entry.name);
        $('#current_info').append('<div>').append(entry.description);
    }

    function populateLinkHtml(node){

        var entry = node.getEntry();
        var currentroot = node.computeUrlBase();

        $('#current_links').empty();
        $('#current_items').empty();
        $('#alternate_links').empty();
        $('#unknown_links').empty();

        $.each(entry.links, function(idx, value){

            var lnk = currentroot + value.href;
            var vr = "'" + value.href + "'";
            var vrel = "'" + value.rel + "'";

            if ('self' == value.rel) {
                //ignore

            } else if ('parent' == value.rel) {
                //ignore

            } else {
                $('#current_links').append('<span>').append(value.rel).append('<br />');
                $('#current_links').append(  '<a onclick="event.preventDefault(); goTo(' +vrel+ ', '+ vr +')" href="' + value.href + '">'+ lnk +'</a>'  ).append('<p>');
            }
        });
    }

</script>
</body>

</html>